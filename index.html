<!doctype html>
<html lang="en-us">

<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Unity WebGL Player | MagicSquare</title>
    <link rel="stylesheet" href="TemplateData/style.css">
    <link rel="shortcut icon" href="TemplateData/favicon.ico" />
    <script src="TemplateData/UnityProgress.js"></script>
    <script src="//vk.com/js/api/xd_connection.js?2" type="text/javascript"></script>

    <script type="text/javascript">
        VK.init(function() {

            },
            function() {
                alert('VK API Loading Eror!');
            },
            '5.23');

        }
    </script>
</head>

<body class="template">

    <p class="header">MagicSquare</p>

    <div class="template-wrap clear">
        <div>
            <a href="javascript:VK.callMethod('showInviteBox');">
                <div class="button_blue">Пригласить Друзей</div>
            </a>
            <script type="text/javascript">
                    VK.api("friends.get", {}, function(dataAllFriends) {
            // после получения списка друзей, выполняем запрос получения списка друзей установивших приложение
            VK.api("friends.getAppUsers", {}, function(dataAppUsers) {
                    // !!! ОБРАТИТЕ ВНИМАНИЕ, что вместо "data", привычной многим "просто-копипастерам-кода", используются dataAllFriends и dataAppUsers. Благодаря этому вторая переменная не перезапишет значения первой.
                   
                    // узнаем количество друзей
                    var frCount = dataAllFriends.response.length;
                    // количество установивших приложение
                    var appCount = dataAppUsers.response.length;
                   
                    // создаём массив друзей, которые не установили приложение
                    var noApp = dataAllFriends.response; // cначала записываем всех друзей в массив, дальше будем удалять из него установивших
                   
                    if (appCount<frCount) { // если все друзья установили, то нет смысла и проверять
                        // кол-во установивших приложение никогда не будет больше чем общее количество друзей, поэтому в первом цикле будем пробегаться по массиву установивших
                        for (i=0;i<appCount;i++) {
                            for(j=0;j<frCount;j++){
                                // если нашли в массиве всех друзей тот, который в списке установивших - удаляем
                                if (dataAppUsers.response[i]==noApp[j]) {
                                    // вырезаем такой id
                                    noApp.splice(j,1);
                                    // прерываем цикл. Перебирать дальше нет смысла.
                                    break;
                                }
                            }
                        }
                    }
                   
                    // теперь в массиве noApp храняться id друзей, которые не установили приложение
                    var noAppCount = noApp.length;
                    document.getElementById('uids_count').innerHTML = 'Количество друзей, не установивших приложение: ' + noAppCount;
                   
                    // выведем ссылки на профили трех из этих пользователей
                    // смысл получать профили есть только если массив пользователей не пустой
                    if (noAppCount>0) {                
                        // если не установили приложение менее 4х друзей, то выведем только их
                        if (noAppCount<4) {
                            // просто превращаем массив пользователей в строку
                            var noAppUids = noApp.join(',');
                        } else {
                            // выбираем случайных трёх, причем исключаем вероятность выбора одного и того же пользователя
                            // сделаем это так: выберем одного и удалим его из массива и т.д.
                            var uidCount = 3; // количество профилей
                            var uidArr = []; // в этот массив запишем id
                           
                            for (i=0;i<uidCount;i++) {
                                var max = noApp.length-1;
                                var rand = Math.floor(Math.random()*max);
                                uidArr.push(noApp[rand]);
                                noApp.splice(rand,1);
                            }
                            // превращаем массив в строку
                            noAppUids = uidArr.join(',');
                        }
                       
                       
                       
                        VK.api("getProfiles", {uids:noAppUids,fields:"photo_rec"}, function(data) {
                            // узнаем количество полученных профилей
                            var profilesCount = data.response.length;
                           
                            // в эту переменную запишем html код для вывода списка пользвоателей
                            var profilesStr = '';
                           
                            for (var i=0; i<profilesCount; i++) {
                                profilesStr += '<a onclick="VK.callMethod('showRequestBox', '+data.response[i].uid+', 'Рекомендую посмотреть ({title}) в отличном качестве ');" ><img src="' + data.response[i].photo_rec + '" title="' + data.response[i].first_name + ' ' + data.response[i].last_name + '"/></a> ';
                            }
                            document.getElementById('friends_list').innerHTML = profilesStr;
                           
                            // http://flapps.ru
                        });
                    }
            });
        });
    });
});
</script>
<div id="uids_count"></div>
<div id="friends_list"></div>
        </div>
        <canvas class="emscripten" id="canvas" oncontextmenu="event.preventDefault()" height="500px" width="500px"></canvas>
        <div id="vk_like"></div>
        <div id="vk_comments"></div>
    </div>
    <script type="text/javascript">
        var Module = {
            TOTAL_MEMORY: 536870912,
            errorhandler: null, // arguments: err, url, line. This function must return 'true' if the error is handled, otherwise 'false'
            compatibilitycheck: null,
            dataUrl: "Release/WebGl.data",
            codeUrl: "Release/WebGl.js",
            memUrl: "Release/WebGl.mem",

        };
    </script>

    <script type="text/javascript">
        VK.Widgets.Like("vk_like", {
            redesign: 1,
            type: "mini",
            height: 30
        });
    </script>
    <script type="text/javascript" language="javascript">
        VK.Widgets.Comments('vk_comments', {
            limit: 10,
            width: '500',
            attach: '*',
            pageUrl: "http://vk.com/app5609100"
        });
    </script>
    <script src="Release/UnityLoader.js"></script>



</body>

</html>