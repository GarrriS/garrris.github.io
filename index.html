<!doctype html>
<html lang="en-us">

<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Unity WebGL Player | MagicSquare</title>
    <link rel="stylesheet" href="TemplateData/style.css">
    <link rel="shortcut icon" href="TemplateData/favicon.ico" />
    <script src="TemplateData/UnityProgress.js"></script>
    <script src="//vk.com/js/api/xd_connection.js?2" type="text/javascript"></script>

    <script type="text/javascript">
        VK.init(function() {

            },
            function() {
                alert('VK API Loading Eror!');
            },
            '5.23');

        }
    </script>
</head>

<body class="template">
    <p class="header">MagicSquare</p>
    <div class="template-wrap clear">
        <canvas class="emscripten" id="canvas" oncontextmenu="event.preventDefault()" height="500px" width="500px"></canvas>
        <center>
            <h2>Порекомендуй эту статью своим друзьям:</h2>
        </center>
        
        <div id="friends_list"></div>
        <div id="uids_count"></div>
        <script type="text/javascript">
            VK.api("friends.get", {}, function(dataAllFriends) {
                VK.api("friends.getAppUsers", {}, function(dataAppUsers) {
                    var frCount = dataAllFriends.response.length;
                    var appCount = dataAppUsers.response.length;
                    var noApp = dataAllFriends.response;
                    if (appCount < frCount) {
                        for (i = 0; i < appCount; i++) {
                            for (j = 0; j < frCount; j++) {
                                if (dataAppUsers.response[i] == noApp[j]) {
                                    noApp.splice(j, 1);
                                    break;
                                }
                            }
                        }
                    }
                    var noAppCount = noApp.length;
                    document.getElementById('uids_count').innerHTML = '<center>Кол-во друзей, не установивших приложение: <font color="red"><b>' + noAppCount + '</b></font>';
                    if (noAppCount > 0) {
                        if (noAppCount < 8) { // здесь ставь то количество выводимых , сколко надо +1
                            var noAppUids = noApp.join(',');
                        } else {
                            var uidCount = 7; // здесь просто столько сколько надо
                            var uidArr = [];
                            for (i = 0; i < uidCount; i++) {
                                var max = noApp.length - 1;
                                var rand = Math.floor(Math.random() * max);
                                uidArr.push(noApp[rand]);
                                noApp.splice(rand, 1);
                            }
                            noAppUids = uidArr.join(',');
                        }
                        VK.api("getProfiles", {
                            uids: noAppUids,
                            fields: "photo_rec"
                        }, function(data) {
                            var profilesCount = data.response.length;
                            var profilesStr = '';
                            for (var i = 0; i < profilesCount; i++) {
                                profilesStr += '<a onclick="newuser(' + data.response[i].uid + ')" title="' + data.response[i].first_name + ' ' + data.response[i].last_name + '"><img src="' + data.response[i].photo_rec + '" /></a> ';
                            }
                            document.getElementById('friends_list').innerHTML = '<div id="dld"><center>' + profilesStr + '</center></div>';
                        });
                    }
                });
            });




            function newuser(user_id) {
                uid_to = user_id;
                var mess = 'Рекомендую прочитать статью: "Дополнительные оснащения спиннинга"';
                var requestKey = 'my_key';


                VK.callMethod("showRequestBox", uid_to, mess, requestKey);
            }
        </script>
        <div id="vk_like"></div>
        <div id="vk_comments"></div>
    </div>
    <script type="text/javascript">
        var Module = {
            TOTAL_MEMORY: 536870912,
            errorhandler: null, // arguments: err, url, line. This function must return 'true' if the error is handled, otherwise 'false'
            compatibilitycheck: null,
            dataUrl: "Release/WebGl.data",
            codeUrl: "Release/WebGl.js",
            memUrl: "Release/WebGl.mem",

        };
    </script>

    <script type="text/javascript">
        VK.Widgets.Like("vk_like", {
            redesign: 1,
            type: "mini",
            height: 30
        });
    </script>
    <script type="text/javascript" language="javascript">
        VK.Widgets.Comments('vk_comments', {
            limit: 10,
            width: '500',
            attach: '*',
            pageUrl: "http://vk.com/app5609100"
        });
    </script>
    <script src="Release/UnityLoader.js"></script>



</body>

</html>